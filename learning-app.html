<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Learn - Interactive Slides</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="main">
            <h1>Learn</h1>
            <div id="slideContainer" class="slide-container"></div>
        </div>
        <div class="sidebar">
            <button id="toggleReviewBtn" class="btn btn-secondary">Review</button>
            <div id="reviewArea" class="panel review-panel" style="display: none;">
                <h3>Review</h3>
                <div id="reviewContent" class="panel-content" contenteditable="false"></div>
                <button id="editReviewBtn" class="btn btn-secondary">Edit Review</button>
            </div>
            <div id="notesArea" class="panel notes-panel">
                <h3>Notes</h3>
                <textarea id="notesInput" class="panel-content" placeholder="Type your notes here..."></textarea>
                <button id="saveNotesBtn" class="btn btn-primary">Save Notes</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import { fetchTopics } from './db.js';

        const topicSelect = document.createElement('select');
        topicSelect.id = 'topicSelect';
        const slideContainer = document.getElementById('slideContainer');
        const toggleReviewBtn = document.getElementById('toggleReviewBtn');
        const editReviewBtn = document.getElementById('editReviewBtn');
        const reviewArea = document.getElementById('reviewArea');
        const reviewContent = document.getElementById('reviewContent');
        const notesInput = document.getElementById('notesInput');
        const saveNotesBtn = document.getElementById('saveNotesBtn');
        let topics = {};
        let currentSlideIndex = 0;
        let reviewData = {};

        async function init() {
            topics = await fetchTopics();
            console.log('Fetched topics:', topics);
            if (Object.keys(topics).length === 0) {
                topics = JSON.parse(localStorage.getItem('topics')) || {};
                console.log('Using cached topics from localStorage:', topics);
            }
            reviewData = JSON.parse(localStorage.getItem('reviewData')) || {};
            populateTopicSelect();
            displaySlide();
            loadNotes();
        }

        function populateTopicSelect() {
            topicSelect.innerHTML = '';
            Object.keys(topics).forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic.charAt(0).toUpperCase() + topic.slice(1).replace(/([A-Z])/g, ' $1');
                topicSelect.appendChild(option);
            });
            if (Object.keys(topics).length === 0) {
                topicSelect.innerHTML = '<option value="">No topics available</option>';
            }
        }

        function displaySlide() {
            slideContainer.innerHTML = '';
            const currentTopic = topicSelect.value;
            if (!currentTopic || !topics[currentTopic] || topics[currentTopic].length === 0) {
                slideContainer.innerHTML = '<p class="no-content">No slides available for this topic.</p>';
                return;
            }

            const slide = topics[currentTopic][currentSlideIndex];
            console.log(`Rendering slide ${currentSlideIndex}:`, slide);
            const slideDiv = document.createElement('div');
            slideDiv.className = 'slide';

            let content = `
                <div class="slide-header">
                    <select id="topicSelect" class="topic-select">${topicSelect.innerHTML}</select>
                </div>
                <div class="slide-content">
            `;

            if (slide.type === 'question' || slide.type === 'mcq') {
                content += `
                    <p>${slide.prompt || 'No prompt available'}</p>
                    ${slide.options ? slide.options.map((opt, i) => `
                        <label class="option"><input type="radio" name="mcq-${currentSlideIndex}" value="${i}"> ${opt}</label><br>
                    `).join('') : '<p>No options provided</p>'}
                    <div class="submit-container">
                        <button class="btn btn-primary submit-btn" data-index="${currentSlideIndex}">Submit</button>
                    </div>
                    <span class="feedback" id="feedback-${currentSlideIndex}"></span>
                    <span class="error" id="error-${currentSlideIndex}"></span>
                `;
            } else if (slide.type === 'display') {
                content += `
                    <p>${slide.text || 'No content available'}</p>
                `;
            } else if (slide.type === 'fill') {
                content += `
                    <p>${slide.prompt ? slide.prompt.replace('___', `<input type="text" id="fill-${currentSlideIndex}" class="cloze-input">`) : 'No prompt provided'}</p>
                    <div class="submit-container">
                        <button class="btn btn-primary submit-btn" data-index="${currentSlideIndex}">Submit</button>
                    </div>
                    <span class="feedback" id="feedback-${currentSlideIndex}"></span>
                    <span class="error" id="error-${currentSlideIndex}"></span>
                `;
            } else if (slide.type === 'match') {
                content += `
                    <p>${slide.prompt || 'Match the following'}</p>
                    <div class="match-container" id="match-${currentSlideIndex}">
                        <div class="match-left">
                            ${slide.items ? slide.items.map((item, i) => `<div class="draggable" draggable="true" data-index="${i}">${item.a}</div>`).join('') : 'No items'}
                        </div>
                        <div class="match-right">
                            ${slide.items ? slide.items.map((item, i) => `<div class="dropzone" data-index="${i}">${item.b}</div>`).join('') : 'No items'}
                        </div>
                    </div>
                    <div class="submit-container">
                        <button class="btn btn-primary submit-btn" data-index="${currentSlideIndex}">Submit</button>
                    </div>
                    <span class="feedback" id="feedback-${currentSlideIndex}"></span>
                    <span class="error" id="error-${currentSlideIndex}"></span>
                `;
            } else if (slide.type === 'reorder') {
                content += `
                    <p>${slide.prompt || 'Reorder the following'}</p>
                    <div class="reorder-container" id="reorder-${currentSlideIndex}">
                        ${slide.items ? slide.items.map((item, i) => `<div class="draggable" draggable="true" data-index="${i}">${item}</div>`).join('') : 'No items'}
                    </div>
                    <div class="submit-container">
                        <button class="btn btn-primary submit-btn" data-index="${currentSlideIndex}">Submit</button>
                    </div>
                    <span class="feedback" id="feedback-${currentSlideIndex}"></span>
                    <span class="error" id="error-${currentSlideIndex}"></span>
                `;
            } else if (slide.type === 'truefalse') {
                content += `
                    <p>${slide.prompt || 'No prompt available'}</p>
                    <label class="option"><input type="radio" name="tf-${currentSlideIndex}" value="true"> True</label><br>
                    <label class="option"><input type="radio" name="tf-${currentSlideIndex}" value="false"> False</label><br>
                    <div class="submit-container">
                        <button class="btn btn-primary submit-btn" data-index="${currentSlideIndex}">Submit</button>
                    </div>
                    <span class="feedback" id="feedback-${currentSlideIndex}"></span>
                    <span class="error" id="error-${currentSlideIndex}"></span>
                `;
            } else if (slide.type === 'shortanswer') {
                content += `
                    <p>${slide.prompt || 'No prompt available'}</p>
                    <textarea id="sa-${currentSlideIndex}" class="shortanswer-input" placeholder="Your answer..."></textarea>
                    <div class="submit-container">
                        <button class="btn btn-primary submit-btn" data-index="${currentSlideIndex}">Submit</button>
                    </div>
                    <span class="feedback" id="feedback-${currentSlideIndex}"></span>
                    <span class="error" id="error-${currentSlideIndex}"></span>
                `;
            } else if (slide.type === 'cloze') {
                content += `
                    <p>${slide.text ? slide.text.replace(/___/g, (_, i) => `<input type="text" id="cloze-${currentSlideIndex}-${i}" class="cloze-input">`) : 'No text provided'}</p>
                    <div class="submit-container">
                        <button class="btn btn-primary submit-btn" data-index="${currentSlideIndex}">Submit</button>
                    </div>
                    <span class="feedback" id="feedback-${currentSlideIndex}"></span>
                    <span class="error" id="error-${currentSlideIndex}"></span>
                `;
            } else if (slide.type === 'image') {
                content += `
                    <div class="image-container">
                        <img src="${slide.imageUrl || 'https://via.placeholder.com/300'}" alt="Image for labeling" class="label-image">
                        ${slide.labels ? slide.labels.map((label, i) => `
                            <input type="text" id="image-${currentSlideIndex}-${i}" class="label-input" style="position: absolute; left: ${label.x || 50}px; top: ${label.y || 50}px;">
                        `).join('') : '<p>No labels provided</p>'}
                    </div>
                    <div class="submit-container">
                        <button class="btn btn-primary submit-btn" data-index="${currentSlideIndex}">Submit</button>
                    </div>
                    <span class="feedback" id="feedback-${currentSlideIndex}"></span>
                    <span class="error" id="error-${currentSlideIndex}"></span>
                `;
            } else if (slide.type === 'conceptmap') {
                content += `
                    <p>${slide.prompt || 'Connect the concepts'}</p>
                    <div class="conceptmap-container" id="conceptmap-${currentSlideIndex}">
                        ${slide.nodes ? slide.nodes.map((node, i) => `
                            <div class="node" draggable="true" data-index="${i}" style="position: absolute; left: ${i * 100}px; top: 50px;">${node}</div>
                        `).join('') : '<p>No nodes provided</p>'}
                    </div>
                    <div class="submit-container">
                        <button class="btn btn-primary submit-btn" data-index="${currentSlideIndex}">Submit</button>
                    </div>
                    <span class="feedback" id="feedback-${currentSlideIndex}"></span>
                    <span class="error" id="error-${currentSlideIndex}"></span>
                `;
            } else {
                content += `<p>Unsupported slide type: ${slide.type}</p>`;
            }

            if (slide.explanation) {
                content += `<details class="explanation"><summary>Explanation</summary><div>${slide.explanation}</div></details>`;
            }

            content += `</div>`; // Close slide-content
            content += `
                <div class="slide-footer">
                    <button id="nextSlideBtn-${currentSlideIndex}" class="btn btn-primary next-slide-btn" style="display: ${currentSlideIndex < topics[currentTopic].length - 1 ? 'block' : 'none'};">Next Slide</button>
                </div>
            `;

            slideDiv.innerHTML = content;
            slideContainer.appendChild(slideDiv);

            // Attach event listener to the new Next Slide button
            const nextBtn = slideDiv.querySelector(`#nextSlideBtn-${currentSlideIndex}`);
            nextBtn.addEventListener('click', () => {
                console.log(`Next Slide button clicked for slide ${currentSlideIndex}`);
                nextSlide();
            });

            document.querySelectorAll('.submit-btn').forEach(btn => {
                btn.addEventListener('click', () => checkAnswer(btn.dataset.index));
            });

            document.querySelectorAll('.draggable').forEach(draggable => {
                draggable.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.index);
                });
            });

            document.querySelectorAll('.dropzone').forEach(dropzone => {
                dropzone.addEventListener('dragover', e => e.preventDefault());
                dropzone.addEventListener('drop', e => {
                    e.preventDefault();
                    const draggedIndex = e.dataTransfer.getData('text/plain');
                    e.target.dataset.matchIndex = draggedIndex;
                });
            });

            document.querySelectorAll('.reorder-container .draggable').forEach(draggable => {
                draggable.addEventListener('dragover', e => e.preventDefault());
                draggable.addEventListener('drop', e => {
                    e.preventDefault();
                    const draggedIndex = e.dataTransfer.getData('text/plain');
                    const dropIndex = e.target.dataset.index;
                    const container = e.target.parentElement;
                    const items = Array.from(container.children);
                    const draggedItem = items[draggedIndex];
                    const dropItem = items[dropIndex];
                    container.insertBefore(draggedItem, dropItem);
                    updateReorderIndices(container);
                });
            });

            document.querySelectorAll('.node').forEach(node => {
                node.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.index);
                });
                node.addEventListener('dragend', e => {
                    e.target.style.left = `${e.clientX - 50}px`;
                    e.target.style.top = `${e.clientY - 20}px`;
                });
            });

            updateReview();
        }

        function updateReorderIndices(container) {
            container.querySelectorAll('.draggable').forEach((item, i) => {
                item.dataset.index = i;
            });
        }

        function checkAnswer(index) {
            const slide = topics[topicSelect.value][index];
            const feedback = document.getElementById(`feedback-${index}`);
            const error = document.getElementById(`error-${index}`);
            let isCorrect = false;

            feedback.textContent = '';
            error.textContent = '';
            feedback.style.display = 'none';
            error.style.display = 'none';

            if (slide.type === 'question' || slide.type === 'mcq') {
                const selected = document.querySelector(`input[name="mcq-${index}"]:checked`);
                isCorrect = selected && parseInt(selected.value) === slide.correct;
                feedback.textContent = isCorrect ? 'Correct!' : '';
                error.textContent = isCorrect ? '' : 'Incorrect';
            } else if (slide.type === 'display') {
                isCorrect = true;
                feedback.textContent = 'Viewed';
            } else if (slide.type === 'fill') {
                const userAnswer = document.getElementById(`fill-${index}`).value.trim().toLowerCase();
                isCorrect = userAnswer === slide.answer?.toLowerCase();
                feedback.textContent = isCorrect ? 'Correct!' : '';
                error.textContent = isCorrect ? '' : 'Try again';
            } else if (slide.type === 'match') {
                const dropzones = document.querySelectorAll(`#match-${index} .dropzone`);
                const userOrder = Array.from(dropzones).map(dz => parseInt(dz.dataset.matchIndex));
                isCorrect = JSON.stringify(userOrder) === JSON.stringify(slide.correct);
                feedback.textContent = isCorrect ? 'Correct!' : '';
                error.textContent = isCorrect ? '' : 'Incorrect';
            } else if (slide.type === 'reorder') {
                const items = document.querySelectorAll(`#reorder-${index} .draggable`);
                const userOrder = Array.from(items).map(item => parseInt(item.dataset.index));
                isCorrect = JSON.stringify(userOrder) === JSON.stringify(slide.correct);
                feedback.textContent = isCorrect ? 'Correct!' : '';
                error.textContent = isCorrect ? '' : 'Incorrect';
            } else if (slide.type === 'truefalse') {
                const selected = document.querySelector(`input[name="tf-${index}"]:checked`);
                isCorrect = selected && (selected.value === 'true') === slide.correct;
                feedback.textContent = isCorrect ? 'Correct!' : '';
                error.textContent = isCorrect ? '' : 'Incorrect';
            } else if (slide.type === 'shortanswer') {
                const userAnswer = document.getElementById(`sa-${index}`).value.trim().toLowerCase();
                isCorrect = userAnswer === slide.answer?.toLowerCase();
                feedback.textContent = isCorrect ? 'Correct!' : '';
                error.textContent = isCorrect ? '' : 'Try again';
            } else if (slide.type === 'cloze') {
                const inputs = document.querySelectorAll(`[id^="cloze-${index}-"]`);
                const userAnswers = Array.from(inputs).map(input => input.value.trim().toLowerCase());
                const correctAnswers = slide.answers ? slide.answers.map(a => a.toLowerCase()) : [];
                isCorrect = JSON.stringify(userAnswers) === JSON.stringify(correctAnswers);
                feedback.textContent = isCorrect ? 'Correct!' : '';
                error.textContent = isCorrect ? '' : 'Try again';
            } else if (slide.type === 'image') {
                const inputs = document.querySelectorAll(`[id^="image-${index}-"]`);
                const userLabels = Array.from(inputs).map(input => input.value.trim().toLowerCase());
                const correctLabels = slide.correct ? slide.correct.map(c => c.toLowerCase()) : [];
                isCorrect = JSON.stringify(userLabels) === JSON.stringify(correctLabels);
                feedback.textContent = isCorrect ? 'Correct!' : '';
                error.textContent = isCorrect ? '' : 'Try again';
            } else if (slide.type === 'conceptmap') {
                feedback.textContent = 'Concept map submitted (visual check only)';
                isCorrect = true;
            }

            if (isCorrect) {
                feedback.style.display = 'inline';
                reviewData[topicSelect.value] = reviewData[topicSelect.value] || {};
                reviewData[topicSelect.value][slide.id] = {
                    prompt: slide.prompt || slide.text || 'Concept Map',
                    answer: slide.type === 'question' || slide.type === 'mcq' ? slide.options[slide.correct] :
                            slide.type === 'fill' ? slide.answer :
                            slide.type === 'match' ? 'Matched' :
                            slide.type === 'reorder' ? 'Reordered' :
                            slide.type === 'truefalse' ? slide.correct.toString() :
                            slide.type === 'shortanswer' ? slide.answer :
                            slide.type === 'cloze' ? slide.answers.join(', ') :
                            slide.type === 'image' ? slide.correct.join(', ') :
                            slide.type === 'conceptmap' ? 'N/A' : 'Viewed',
                    correct: true
                };
                localStorage.setItem('reviewData', JSON.stringify(reviewData));
                setTimeout(nextSlide, 2000);
            } else {
                error.style.display = 'inline';
            }
            updateReview();
        }

        function nextSlide() {
            const currentTopic = topicSelect.value;
            console.log(`Advancing from slide ${currentSlideIndex} of ${topics[currentTopic].length - 1}`);
            if (currentSlideIndex < topics[currentTopic].length - 1) {
                currentSlideIndex++;
                displaySlide();
            } else {
                console.log('No more slides to advance to');
            }
        }

        function updateReview() {
            const currentTopic = topicSelect.value;
            reviewContent.innerHTML = '';
            if (reviewData[currentTopic]) {
                Object.entries(reviewData[currentTopic]).forEach(([slideId, data]) => {
                    reviewContent.innerHTML += `
                        <p><strong>${data.prompt}</strong><br>
                        Your answer: ${data.answer}<br>
                        ${data.correct ? 'Correct' : 'Incorrect'}</p>
                    `;
                });
            } else {
                reviewContent.innerHTML = '<p>No review data yet.</p>';
            }
        }

        function loadNotes() {
            const currentTopic = topicSelect.value;
            notesInput.value = localStorage.getItem(`notes_${currentTopic}`) || '';
        }

        function saveNotes() {
            const currentTopic = topicSelect.value;
            localStorage.setItem(`notes_${currentTopic}`, notesInput.value);
            alert('Notes saved!');
        }

        toggleReviewBtn.addEventListener('click', () => {
            reviewArea.style.display = reviewArea.style.display === 'none' ? 'block' : 'none';
        });

        editReviewBtn.addEventListener('click', () => {
            const isEditable = reviewContent.contentEditable === 'true';
            reviewContent.contentEditable = !isEditable;
            editReviewBtn.textContent = isEditable ? 'Edit Review' : 'Save Review';
            if (isEditable) {
                const currentTopic = topicSelect.value;
                reviewData[currentTopic] = reviewData[currentTopic] || {};
                reviewData[currentTopic]['custom'] = reviewContent.innerText;
                localStorage.setItem('reviewData', JSON.stringify(reviewData));
            }
        });

        saveNotesBtn.addEventListener('click', saveNotes);

        topicSelect.addEventListener('change', () => {
            currentSlideIndex = 0;
            displaySlide();
            loadNotes();
            updateReview();
        });

        init();
    </script>
</body>
</html>